<div class="service-list-container">
    <!-- ===============================
       HEADER
  =============================== -->
    <div class="header">
        <div class="header-left">
            <h2>Services Management</h2>
            <p class="subtitle">Manage services, hierarchy & steps</p>
        </div>
        <div class="header-actions">
            <input type="text" class="search-input" placeholder="Search services..." [(ngModel)]="searchTerm"
                (keyup.enter)="onSearch()" />
            <button class="create-btn" [routerLink]="['/admin/dashboard/createservice']"> + Create Service </button>
        </div>
    </div>
    <!-- ===============================
       FILTER PANEL (ADMIN STYLE)
  =============================== -->
    <div class="filters-panel">
        <div class="filter-group">
            <label>Category</label>
            <select [(ngModel)]="selectedCategoryId" (ngModelChange)="onCategoryChange($event)">
                <option [ngValue]="null">All Categories</option>
                <option *ngFor="let c of categories" [ngValue]="c.id"> {{ c.name }} </option>
            </select>
        </div>
        <div class="filter-group">
            <label>Type</label>
            <select [(ngModel)]="selectedTypeId" (ngModelChange)="onTypeChange($event)" [disabled]="!types.length">
                <option [ngValue]="null">All Types</option>
                <option *ngFor="let t of types" [ngValue]="t.id"> {{ t.name }} </option>
            </select>
        </div>
        <div class="filter-group">
            <label>Structure</label>
            <select [(ngModel)]="selectedStructureId" (ngModelChange)="onStructureChange($event)"
                [disabled]="!structures.length">
                <option [ngValue]="null">All Structures</option>
                <option *ngFor="let s of structures" [ngValue]="s.id"> {{ s.name }} </option>
            </select>
        </div>
        <div class="filter-group">
            <label>Part</label>
            <select [(ngModel)]="selectedPartId" (ngModelChange)="onPartChange($event)" [disabled]="!parts.length">
                <option [ngValue]="null">All Parts</option>
                <option *ngFor="let p of parts" [ngValue]="p.id"> {{ p.name }} </option>
            </select>
        </div>
        <div class="filter-group">
            <label>Option</label>
            <select [(ngModel)]="selectedOptionId" (ngModelChange)="onOptionChange($event)"
                [disabled]="!options.length">
                <option [ngValue]="null">All Options</option>
                <option *ngFor="let o of options" [ngValue]="o.id"> {{ o.name }} </option>
            </select>
        </div>
    </div>
    <!-- ===============================
       SERVICE TABLE
  =============================== -->
    <table class="service-table" *ngIf="!isLoading; else loading">
        <thead>
            <tr>
                <th>Name</th>
                <th>Description</th>
                <th>Base Cost</th>
                <th>Warranty</th>
                <th>Delivery</th>
                <th>Linked To</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let service of services">
                <td class="name-cell">{{ service.name }}</td>
                <td class="desc-cell"> {{ service.description || '—' }} </td>
                <td>{{ service.baseCost | currency }}</td>
                <td> {{ service.warrantyDuration }} {{ service.warrantyUnit }} </td>
                <td>{{ service.deliveryDays }} days</td>
                <td class="linked-cell">
                    <span *ngIf="service.categoryName">
                        <strong>Category:</strong> {{ service.categoryName }} </span>
                    <span *ngIf="service.categoryTypeName">
                        <strong>Type:</strong> {{ service.categoryTypeName }} </span>
                    <span *ngIf="service.structureName">
                        <strong>Structure:</strong> {{ service.structureName }} </span>
                    <span *ngIf="service.partName">
                        <strong>Part:</strong> {{ service.partName }} </span>
                    <span *ngIf="service.partOptionName">
                        <strong>Option:</strong> {{ service.partOptionName }} </span>
                </td>
                <td class="actions-cell">
                    <button class="steps-btn" (click)="openStepsModal(service)"> Steps </button>
                    <button class="edit-btn" [routerLink]="['/admin/dashboard/editservice', service.id]"> Edit </button>
                    <button class="delete-btn" (click)="onDelete(service.id!)"> Delete </button>
                </td>
            </tr>
        </tbody>
    </table>
    <!-- ===============================
       LOADING
  =============================== -->
    <ng-template #loading>
        <div class="loading">Loading services...</div>
    </ng-template>
    <!-- ===============================
       PAGINATION
  =============================== -->
    <div class="pagination">
        <button [disabled]="page === 1" (click)="onPageChange(page - 1)"> Prev </button>
        <span>Page {{ page }}</span>
        <button [disabled]="services.length < pageSize" (click)="onPageChange(page + 1)"> Next </button>
    </div>
    <!-- ===============================
       STEPS MODAL (UNCHANGED)
  =============================== -->
    <div class="steps-modal-backdrop" *ngIf="selectedService && showStepsModal">
        <div class="steps-modal">
            <div class="steps-header">
                <h3>{{ selectedService.name }} — Steps</h3>
                <button class="close-btn" (click)="closeStepsModal()"> &times; </button>
            </div>
            <div class="steps-body">
                <table class="steps-table" *ngIf="serviceSteps.length; else noSteps">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let step of serviceSteps">
                            <td>{{ step.stepOrder }}</td>
                            <td>{{ step.description }}</td>
                            <td>
                                <button class="delete-btn" (click)="deleteStep(step.id!, step.serviceId!)"> Delete
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <ng-template #noSteps>
                    <p class="no-steps">No steps defined yet.</p>
                </ng-template>
                <div class="add-step-card">
                    <h4>Add New Step</h4>
                    <form [formGroup]="CreateStepForm" (ngSubmit)="onAddStep(CreateStepForm)">
                        <input type="text" formControlName="description" placeholder="Step description" />
                        <button type="submit" class="add-btn" [disabled]="CreateStepForm.invalid"> + Add Step </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>