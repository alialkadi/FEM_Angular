<div class="create-service-container">
    <form [formGroup]="serviceForm" (ngSubmit)="onSubmit()">
        <div class="form-grid">
            <!-- =========================================== -->
            <!-- LEFT: SERVICE LINKAGE -->
            <!-- =========================================== -->
            <div class="linkage-card">
                <h3>Service Linkage</h3>
                <p>Select where this service applies in the hierarchy.</p>
                <!-- Linkage Tabs -->
                <div class="tab-buttons">
                    <button type="button" [class.active]="activeLinkage === 'Structure'"
                        (click)="setLinkage('Structure')"> Structure </button>
                    <button type="button" [class.active]="activeLinkage === 'Part'" (click)="setLinkage('Part')"> Part
                    </button>
                    <button type="button" [class.active]="activeLinkage === 'PartOption'"
                        (click)="setLinkage('PartOption')"> Part Option </button>
                </div>
                <!-- CATEGORY -->
                <div class="select-group">
                    <label>Category</label>
                    <select formControlName="categoryId" (change)="onCategoryChange($event)">
                        <option value="">Select Category</option>
                        <option *ngFor="let c of categories" [value]="c.id"> {{ c.name }} </option>
                    </select>
                </div>
                <!-- CATEGORY TYPE -->
                <div class="select-group" *ngIf="categoryTypes.length">
                    <label>Category Type</label>
                    <select formControlName="categoryTypeId" (change)="onCategoryTypeChange($event)">
                        <option value="">Select Category Type</option>
                        <option *ngFor="let t of categoryTypes" [value]="t.id"> {{ t.name }} </option>
                    </select>
                </div>
                <!-- STRUCTURE -->
                <ng-container *ngIf="activeLinkage === 'Structure'">
                    <div class="select-group" *ngIf="structures.length">
                        <label>Structure</label>
                        <select formControlName="structureId">
                            <option value="">Select Structure</option>
                            <option *ngFor="let s of structures" [value]="s.id"> {{ s.name }} </option>
                        </select>
                    </div>
                </ng-container>
                <!-- PART -->
                <ng-container *ngIf="activeLinkage === 'Part'">
                    <div class="select-group" *ngIf="structures.length">
                        <label>Structure</label>
                        <select formControlName="structureId" (change)="onStructureChange($event)">
                            <option value="">Select Structure</option>
                            <option *ngFor="let s of structures" [value]="s.id"> {{ s.name }} </option>
                        </select>
                    </div>
                    <div class="select-group" *ngIf="parts.length">
                        <label>Part</label>
                        <select formControlName="partId">
                            <option value="">Select Part</option>
                            <option *ngFor="let p of parts" [value]="p.id"> {{ p.name }} </option>
                        </select>
                    </div>
                </ng-container>
                <!-- PART OPTION -->
                <ng-container *ngIf="activeLinkage === 'PartOption'">
                    <div class="select-group" *ngIf="structures.length">
                        <label>Structure</label>
                        <select formControlName="structureId" (change)="onStructureChange($event)">
                            <option value="">Select Structure</option>
                            <option *ngFor="let s of structures" [value]="s.id"> {{ s.name }} </option>
                        </select>
                    </div>
                    <div class="select-group" *ngIf="parts.length">
                        <label>Part</label>
                        <select formControlName="partId" (change)="onPartChange($event)">
                            <option value="">Select Part</option>
                            <option *ngFor="let p of parts" [value]="p.id"> {{ p.name }} </option>
                        </select>
                    </div>
                    <div class="select-group" *ngIf="partOptions.length">
                        <label>Part Option</label>
                        <select formControlName="partOptionId">
                            <option value="">Select Part Option</option>
                            <option *ngFor="let o of partOptions" [value]="o.id"> {{ o.name }} </option>
                        </select>
                    </div>
                </ng-container>
            </div>
            <!-- =========================================== -->
            <!-- RIGHT: SERVICE DATA -->
            <!-- =========================================== -->
            <div class="service-card">
                <h3>Service Data</h3>
                <p>Enter service details below.</p>
                <div class="form-group">
                    <label>Brand Name <span class="required">*</span></label>
                    <input formControlName="name" type="text" />
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea formControlName="description"></textarea>
                </div>
                <div class="form-group d-none">
                    <label>Series</label>
                    <input formControlName="series" />
                </div>
                <div class="form-group d-none">
                    <label>Locking Point</label>
                    <input formControlName="lockingPoint" />
                </div>
                <div class="form-group d-none">
                    <label>Point Number</label>
                    <input formControlName="pointNumber" />
                </div>
                <div class="form-group">
                    <label>Labors</label>
                    <input type="number" formControlName="labors" />
                </div>
                <!-- FILE -->
                <div class="form-group">
                    <input type="file" (change)="onFileSelected($event)" />
                    <div *ngIf="previewUrl" class="preview">
                        <img [src]="previewUrl" class="preview-img" />
                    </div>
                </div>
                <!-- INLINE FIELDS -->
                <div class="inline-fields">
                    <!-- ================= PRICING MODE ================= -->
                    <div class="pricing-mode-card">
                        <h4>Pricing Mode</h4>
                        <p class="hint"> Choose how the price of this service is calculated. </p>
                        <div class="pricing-mode-options">
                            <label class="mode-option">
                                <input type="radio" name="pricingMode" [checked]="pricingMode === 'Static'"
                                    (change)="pricingMode = 'Static'" />
                                <div>
                                    <strong>Static Pricing</strong>
                                    <small>Fixed price, same for all customers</small>
                                </div>
                            </label>
                            <label class="mode-option">
                                <input type="radio" name="pricingMode" [checked]="pricingMode === 'Dynamic'"
                                    (change)="pricingMode = 'Dynamic'" />
                                <div>
                                    <strong>Dynamic Pricing</strong>
                                    <small>Price calculated from user inputs</small>
                                </div>
                            </label>
                        </div>
                    </div>
                    <!-- ================= STATIC PRICING ================= -->
                    <div class="static-pricing" *ngIf="pricingMode === 'Static'">
                        <h4>Base Price</h4>
                        <p class="hint"> This amount will be used directly as the service base cost. </p>
                        <input type="number" formControlName="baseCost" placeholder="Enter base cost" />
                    </div>
                    <!-- ================= DYNAMIC PRICING OVERVIEW ================= -->
                    <div class="dynamic-pricing" *ngIf="pricingMode === 'Dynamic'">
                        <h4>Dynamic Pricing Rules</h4>
                        <p class="hint"> The service price will be calculated based on the inputs below. </p>
                        <ul class="pricing-explanation">
                            <li>Dimensional inputs are multiplied together</li>
                            <li>Rate inputs are summed and applied to dimensions</li>
                            <li>Fixed inputs are added directly</li>
                            <li>Dependencies control when a rule applies</li>
                        </ul>
                    </div>
                    <div>
                        <label>Warranty Duration</label>
                        <input type="number" formControlName="warrantyDuration" />
                    </div>
                    <div>
                        <label>Warranty Unit</label>
                        <select formControlName="warrantyUnit">
                            <option value="Days">Days</option>
                            <option value="Weeks">Weeks</option>
                            <option value="Months">Months</option>
                        </select>
                    </div>
                    <div>
                        <label>Delivery Days</label>
                        <input type="number" formControlName="deliveryDays" />
                    </div>
                </div>
            </div>
        </div>
        <!-- =========================================== -->
        <!-- METADATA (COLLAPSIBLE – SAME STYLE) -->
        <!-- =========================================== -->
        <div class="service-card metadata-card">
            <div class="metadata-header" (click)="toggleMetadata()">
                <h3>Metadata Attributes</h3>
                <span class="arrow" [class.open]="showMetadata">▼</span>
            </div>
            <div class="metadata-body" *ngIf="showMetadata">
                <app-attribute-assignment [targetType]="metadataTargetType" [targetId]="metadataTargetId"
                    (metadataChange)="onMetadataChange($event)">
                </app-attribute-assignment>
            </div>
        </div>
        <!-- =========================================== -->
        <!-- ACTIONS -->
        <!-- =========================================== -->
        <div class="actions">
            <button type="submit" [disabled]="isSubmitting"> {{ isSubmitting ? 'Saving…' : 'Create Service' }} </button>
        </div>
    </form>
</div>
<!-- ================= DYNAMIC PRICING ================= -->
<div class="pricing-manager" *ngIf="pricingMode === 'Dynamic'">
    <!-- HEADER -->
    <div class="pricing-header">
        <div>
            <h3>Dynamic Pricing Rules</h3>
            <p class="hint"> Define pricing per input value. You can add multiple rates with optional conditions. </p>
        </div>
        <!-- ADD INPUT -->
        <div class="add-input-wrapper">
            <select #inputSelect class="input-select">
                <option value="">Select input</option>
                <option *ngFor="let def of inputDefinitions" [value]="def.id"> {{ def.label }} ({{
                    getPricingTypeLabel(def) }}) </option>
            </select>
            <button type="button" class="btn-primary" (click)="addInputFromSelect(inputSelect.value)"> + Add Input
            </button>
        </div>
    </div>
    <!-- INPUTS -->
    <div class="pricing-inputs">
        <div class="input-card" *ngFor="let input of pricingInputs; let i = index">
            <!-- INPUT HEADER -->
            <div class="input-card-header">
                <div class="title">
                    <h4>{{ input.label }}</h4>
                    <span class="chip">{{ getPricingTypeLabel(input) }}</span>
                </div>
                <button class="icon-btn danger" type="button" (click)="removePricingInput(i)"> ✕ </button>
            </div>
            <!-- SETTINGS -->
            <div class="input-settings">
                <label class="checkbox-row">
                    <input type="checkbox" [(ngModel)]="input.isRequired" /> Required for pricing </label>
                <div *ngIf="input.pricingBehavior === PricingInputBehavior.Dimensional" class="dimension-box">
                    <label>Preview Value</label>
                    <input type="number" [(ngModel)]="input.previewNumericValue" (input)="calculatePreview()" />
                </div>
            </div>
            <!-- VALUES -->
            <div *ngIf="input.dataType === MetadataDataType.Select" class="values-block">
                <div class="value-card" *ngFor="let v of inputValuesMap[input.inputDefinitionId]">
                    <!-- VALUE HEADER -->
                    <div class="value-header">
                        <strong>{{ v.displayName || v.value }}</strong>
                    </div>
                    <!-- RATE ROWS -->
                    <div class="rate-table">
                        <div class="rate-row" *ngFor="let r of v.rates; let ri = index">
                            <div class="rate-cell">
                                <label>Rate</label>
                                <input type="number" placeholder="e.g. 25" [(ngModel)]="r.amount"
                                    (input)="calculatePreview()" />
                            </div>
                            <div class="rate-cell" *ngIf="input.pricingBehavior === PricingInputBehavior.Rate">
                                <label>Apply when</label>
                                <select [(ngModel)]="r.dependsOnValueId" (change)="calculatePreview()">
                                    <option [ngValue]="undefined">Always</option>
                                    <ng-container *ngFor="let parent of pricingInputs">
                                        <ng-container *ngIf="
                        parent.inputDefinitionId !== input.inputDefinitionId &&
                        parent.dataType === MetadataDataType.Select
                      ">
                                            <option *ngFor="let pv of inputValuesMap[parent.inputDefinitionId]"
                                                [ngValue]="pv.id"> {{ parent.label }} = {{ pv.displayName || pv.value }}
                                            </option>
                                        </ng-container>
                                    </ng-container>
                                </select>
                            </div>
                            <div class="rate-actions">
                                <button type="button" class="icon-btn danger" (click)="removeRateRow(v, ri)"> ✕
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- ADD RATE -->
                    <button type="button" class="btn-link" (click)="addRateRow(v)"> + Add pricing condition </button>
                </div>
            </div>
        </div>
    </div>
</div>